clear;

T = 10000;
Tp = 0.5;
opoznienie = 4;

% u1(1:T/Tp) = 0;
% u2(1:T/Tp) = 0;
% u3(1:T/Tp) = 0;
% u4(1:T/Tp) = 0;

% y1(1:T/Tp) = 0;
% y2(1:T/Tp) = 0;
% y3(1:T/Tp) = 0;

y1(1:opoznienie) = 0;
y2(1:opoznienie) = 0;
y3(1:opoznienie) = 0;

% x = [-0.116469025746680, 1.914416994152428, 12.256576514721369,...
%     0.384603121296626, 0.115228616180903, 13.793043896853290,...
%     1.106924330526617, 4.288957780941797, 0.000000001];
% x = [0.635053852967848,39.692937906070690,3.653969134863779,0.176040798425674,16.735229554442782,8.878170184186317,0.315871119171477,78.999165370557140,0.097502818722234];

% Wybór sygna³ów wejœciowych
% 1 - U1, U2, U3
% 2 - U1, U2, U4
% 3 - U2, U3, U4
% 4 - U1, U3, U4
regulator = 3;

switch regulator
    case 1
        % sygna³y U1, U2, U3
        x = [0.282817997548926,12.158988591642236,10.368130323745149,0.203378617763519,15.366333016488060,4.101061582565308,0.041661009192467,2.647323653488802,17.107348482656583];
    case 2
        % sygna³y U1, U2, U4
%         x = [0.927587388209441,70.775969446605610,1.558626363469471,0.332257817507095,40.312382682266540,0.985972242719086,1.324903130531311,1.374023633880412,1.262942182462812e-04];
%         x = [0.201215608139651,14.615679110210124,12.184390650876410,0.062500000000000,16.456022876524738,1.581787809199188,0,8.164934265004890,19.010367274094810];
%         x = [0.011551141159791,1.434883056839078,33.983800875699360,0.010337320842734,2.636509374316690,41.703333962307700,0.032180864789272,2.634829724422872,1.329094898784039];
        x = [0.000001,20.429271207692672,4,0.065871223824546,21.323898403546316,26.908488368221940,1.581033141392481,0.362416927125212,0.000001];
    case 3
        % sygna³y U2, U3, U4
%         x = [0.910014836538045,0.246844228845977,0.428899720271438,0.484036369470006,99.965206925841740,1.070466731268801,0.062500000000000,77.526584381499900,0.015038536180623];
%         x = [0.0001,4.699388097988797,11.392266500366533,1.982121841192281,2.904982869251660,0.012940389779458,0.182522060941385,27.199263682661687,5.707391645143659];
        x = [9.430577834780731,4.488850531025850,0.068067167269255,0.0000001,20.518606560723388,19.166431500865738,0.117003126666619,1.908424829072476e+02,0.276315635250155];
    case 4
        % sygna³y U1, U3, U4
        x = [0.503720860954186,99.951356131604170,5.361381417260883,0.165516459282646,0.853156748960031,0.070899184582490,0.044080994358694,99.608085450327780,2.941855965286189];
end

U = [0 0 0 0;...
    0 0 0 0;...
    0 0 0 0;...
    0 0 0 0];

u1 = U(:,1);
u2 = U(:,2);
u3 = U(:,3);
u4 = U(:,4);

e1 = 0;
e2 = 0;
e3 = 0;

Tskok = 1000;

yzad = [1 2 0.5];
yzad1(1:Tskok) = 0;
yzad1(Tskok+1:T/Tp) = yzad(1);
yzad2(1:Tskok) = 0;
yzad2(Tskok+1:T/Tp) = yzad(2);
yzad3(1:Tskok) = 0;
yzad3(Tskok+1:T/Tp) = yzad(3);

% % Regulator 1
% K1 = 10; %0.5;
% Ti1 = 11.7897; %13;
% Td1 = 0; %3.5;
% r01 = K*(1 + Tp/(2*Ti) + Td/Tp);
% r11 = K*(Tp/(2*Ti) - (2*Td)/Tp - 1);
% r21 = (K*Td)/Tp;
% 
% 
% % Regulator 2
% K2 = 10; %0.5;
% Ti2 = 11.7897; %13;
% Td2 = 0; %3.5;
% r02 = K*(1 + Tp/(2*Ti) + Td/Tp);
% r12 = K*(Tp/(2*Ti) - (2*Td)/Tp - 1);
% r22 = (K*Td)/Tp;
% 
% 
% % Regulator 3
% K3 = 10; %0.5;
% Ti3 = 11.7897; %13;
% Td3 = 0; %3.5;
% r03 = K*(1 + Tp/(2*Ti) + Td/Tp);
% r13 = K*(Tp/(2*Ti) - (2*Td)/Tp - 1);
% r23 = (K*Td)/Tp;

% Regulator 1
K1 = x(1);
Ti1 = x(2);
Td1 = x(3);
r01 = K1*(1 + Tp/(2*Ti1) + Td1/Tp);
r11 = K1*(Tp/(2*Ti1) - (2*Td1)/Tp - 1);
r21 = (K1*Td1)/Tp;


% Regulator 2
K2 = x(4);
Ti2 = x(5);
Td2 = x(6);
r02 = K2*(1 + Tp/(2*Ti2) + Td2/Tp);
r12 = K2*(Tp/(2*Ti2) - (2*Td2)/Tp - 1);
r22 = (K2*Td2)/Tp;


% Regulator 3
K3 = x(7);
Ti3 = x(8);
Td3 = x(9);
r03 = K3*(1 + Tp/(2*Ti3) + Td3/Tp);
r13 = K3*(Tp/(2*Ti3) - (2*Td3)/Tp - 1);
r23 = (K3*Td3)/Tp;

Uplot = [];
Yplot = [];

e = 0;



for k = opoznienie + 1 : T/Tp
    [y1(k),y2(k),y3(k)]=symulacja_obiektu3(u1(k-1),u1(k-2),u1(k-3),u1(k-4),...
                                        u2(k-1),u2(k-2),u2(k-3),u2(k-4),...
                                        u3(k-1),u3(k-2),u3(k-3),u3(k-4),...
                                        u4(k-1),u4(k-2),u4(k-3),u4(k-4),...
                                        y1(k-1),y1(k-2),y1(k-3),y1(k-4),...
                                        y2(k-1),y2(k-2),y2(k-3),y2(k-4),...
                                        y3(k-1),y3(k-2),y3(k-3),y3(k-4));
    
    e = e + (yzad1(k)-y1(k))^2 + (yzad2(k)-y2(k))^2 + (yzad3(k)-y3(k))^2;
    
    e1(k) = yzad1(k)-y1(k);
    e2(k) = yzad2(k)-y2(k);  
    e3(k) = yzad3(k)-y3(k);  
    
    dU1 = r21*e1(k-2) + r11*e1(k-1) + r01*e1(k);
    dU2 = r22*e2(k-2) + r12*e2(k-1) + r02*e2(k);
    dU3 = r23*e3(k-2) + r13*e3(k-1) + r03*e3(k);
    switch regulator
        case 1
            u1(k) = U(1,1)+dU1;
            u2(k) = U(1,2)+dU2;
            u3(k) = U(1,3)+dU3;
            u4(k) = 0;
        case 2
            u1(k) = U(1,1)+dU1;
            u2(k) = U(1,2)+dU2;
            u3(k) = 0;
            u4(k) = U(1,4)+dU3;
        case 3
            u1(k) = 0;
            u2(k) = U(1,2)+dU1;
            u3(k) = U(1,3)+dU2;
            u4(k) = U(1,4)+dU3;
        case 4
            u1(k) = U(1,1)+dU1;
            u2(k) = 0;
            u3(k) = U(1,3)+dU2;
            u4(k) = U(1,4)+dU3;
    end
    
    U = [[u1(k), u2(k), u3(k), u4(k)]; U];
    
    Yplot = [Yplot; [y1(k),y2(k),y3(k)]];
    Uplot = [Uplot; [u1(k), u2(k), u3(k), u4(k)]];
    if mod(k,100) == 0
        k
    end
end
e
figure;
subplot(2,1,1); 
plot(Yplot);
hold on;
plot(yzad1,'--');
plot(yzad2,'--');
plot(yzad3,'--');

subplot(2,1,2); stairs(Uplot);